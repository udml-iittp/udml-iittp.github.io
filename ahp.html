const APPS_SCRIPT_ENDPOINT = "";
<!-- ahp.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>UDML | AHP Weighting Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .site { display:flex; align-items:center; gap:10px; }
    .site img { width:38px; height:38px; object-fit:cover; border-radius:6px; }
    h1 { font-size: 1.5rem; margin: 0; }
    .pill { font-size: .85rem; background:#eef2ff; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 16px; margin: 16px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.03); background:white; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-weight: 600; }
    textarea, input[type="text"], input[type="email"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0;}
    th, td { border: 1px solid #eee; padding: 6px 8px; text-align: center; font-size: 0.92rem; }
    th { background: #fafafa; }
    .btn { cursor:pointer; border:1px solid #ddd; background:white; border-radius:10px; padding:8px 12px; }
    .btn:hover { background:#f9f9f9; }
    .muted { color:#666 }
    .small { font-size: .9rem; }
    .right { text-align:right; }
    .ok { color:#15803d; }
    .warn { color:#b45309; }
    canvas { max-width:100%; }
    footer { margin: 24px 0; color:#666; font-size:0.85rem;}
    nav ul { list-style:none; display:flex; gap:12px; margin:0; padding:0; }
    nav a { text-decoration:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- lightweight top bar to match your site -->
  <header>
    <div class="site">
      <img src="logo.JPG" alt="UDML Logo"/>
      <div>
        <div style="font-weight:700">Urban Dynamics & Mobility Lab, IIT Tirupati</div>
        <div class="small muted">AHP Weighting Survey</div>
      </div>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">About</a></li>
        <li><a href="research.html">Research</a></li>
        <li><a href="members.html">Members</a></li>
        <li><a href="publications.html">Publications</a></li>
        <li><a href="resources.html">Resources</a></li>
        <li><a href="contacts.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <!-- Designer mode -->
  <section class="card">
    <div style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
      <div>
        <h1 style="margin:0;">Configure & Share</h1>
        <p class="small muted" style="margin:4px 0 0 0;">Designer mode: paste your config to generate a shareable link. Respondents will only see the survey.</p>
      </div>
      <span class="pill">MVP · Criteria-only</span>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Config JSON</label>
        <textarea id="config" rows="8">
{
  "model_id": "demo_v1",
  "title": "Urban Flood Vulnerability (Criteria Weights)",
  "instructions": "Compare each pair: which criterion is more important, and by how much (Saaty 1–9).",
  "criteria": ["Exposure","Sensitivity","Adaptive Capacity"]
}
        </textarea>
      </div>
      <div>
        <label>Shareable link</label>
        <input id="sharelink" type="text" readonly />
        <div class="row" style="grid-template-columns:auto auto; margin-top:8px;">
          <button class="btn" onclick="makeLink()">Make link</button>
          <button class="btn" onclick="copyLink()">Copy</button>
        </div>
        <p class="small muted" style="margin-top:8px;">Tip: Put this link under your “Resources → AHP Weighting Survey”.</p>
      </div>
    </div>
  </section>

  <!-- Respondent mode -->
  <section class="card" id="respondent">
    <h2 style="margin:0 0 8px 0" id="survey_title">AHP Survey</h2>
    <p id="survey_instructions" class="muted" style="margin:0 0 16px 0;"></p>

    <!-- Respondent & consent (required) -->
    <div class="row">
      <div>
        <label>Respondent name <span style="color:#b91c1c">*</span></label>
        <input id="resp_name" type="text" placeholder="Your full name" required/>
      </div>
      <div>
        <label>Email <span style="color:#b91c1c">*</span></label>
        <input id="resp_email" type="email" placeholder="email@example.com" required/>
      </div>
    </div>
    <div style="margin-top:12px">
      <label>Affiliation (optional)</label>
      <input id="resp_affil" type="text" placeholder="Institution / Org"/>
    </div>

    <!-- Consent box -->
    <div class="card" style="margin-top:14px; background:#fcfcff">
      <p style="margin:0 0 8px 0; font-weight:600">Consent for Academic Use</p>
      <p class="small muted" style="margin:0 0 8px 0">
        I consent to my responses being used for <b>academic purposes</b>, including teaching and research, by the
        Urban Dynamics &amp; Mobility Lab (UDML), IIT Tirupati. My individual identity will not be disclosed in
        any public output; only aggregated or anonymous results may be reported. Participation is voluntary and I may
        choose not to submit.
      </p>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="resp_consent" type="checkbox" required/>
        <span>I agree and provide my consent.</span>
      </label>
    </div>

    <div id="pairwise_block" style="margin-top:12px;"></div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="computeAHP()">Compute Weights &amp; Consistency</button>
      <div class="right">
        <button class="btn" onclick="exportCSV()">Download CSV</button>
        <button class="btn" onclick="exportJSON()">Download JSON</button>
      </div>
    </div>

    <div id="results" style="display:none; margin-top: 14px">
      <h3 style="margin:8px 0">Results</h3>
      <table id="weights_tbl"></table>
      <p id="consistency_msg" class="small"></p>
      <div class="card">
        <canvas id="chart"></canvas>
      </div>
      <div class="right">
        <button class="btn" onclick="submitToSheets()">Submit</button>
      </div>
      <p class="small muted">If your CR is &gt; 0.10, please revise your judgements above and recompute.</p>
    </div>
  </section>

  <footer>
    <div class="card">
      <b>Saaty (1–9) scale quick guide</b>
      <div class="small">
        1: equal · 3: moderate · 5: strong · 7: very strong · 9: extreme (2/4/6/8 are intermediate).
        Use reciprocals (1/3, 1/5, …) when the column criterion is more important.
      </div>
    </div>
    <p class="small muted">For multiple experts, aggregate their pairwise matrices using the entry-wise geometric mean before recomputing weights &amp; CR.</p>
  </footer>

<script>
/* ====== CONFIG ====== */
const APPS_SCRIPT_ENDPOINT = ""; // <-- paste your Google Apps Script Web App URL here

/* ====== SAATY RI TABLE ====== */
const RI = {1:0.00, 2:0.00, 3:0.58, 4:0.90, 5:1.12, 6:1.24, 7:1.32, 8:1.41, 9:1.45, 10:1.49};

/* ====== DESIGNER: build share link ====== */
function getConfigFromURL() {
  const u = new URL(window.location.href);
  const cfg = u.searchParams.get("cfg");
  if (!cfg) return null;
  try { return JSON.parse(decodeURIComponent(atob(cfg))); } catch { return null; }
}

function makeLink() {
  let cfg;
  try { cfg = JSON.parse(document.getElementById("config").value); }
  catch (e) { alert("Config JSON is invalid."); return; }
  if (!cfg.criteria || !Array.isArray(cfg.criteria) || cfg.criteria.length < 2) {
    alert("Config must include a 'criteria' array with at least two items.");
    return;
  }
  const payload = btoa(encodeURIComponent(JSON.stringify(cfg)));
  const link = `${location.origin}${location.pathname}?cfg=${payload}`;
  document.getElementById("sharelink").value = link;
}

function copyLink() {
  const el = document.getElementById("sharelink");
  if (!el.value) { alert("Create a link first."); return; }
  navigator.clipboard.writeText(el.value).then(()=>alert("Link copied."));
}

/* ====== INIT SURVEY ====== */
function init() {
  const cfg = getConfigFromURL() || safeParse(document.getElementById("config").value) || {
    model_id:"demo_v1",
    title:"AHP Survey",
    instructions:"Compare each pair: which criterion is more important, and by how much (Saaty 1–9).",
    criteria:["Criterion 1","Criterion 2","Criterion 3"]
  };
  window.AHP_CFG = cfg;
  document.getElementById("survey_title").textContent = cfg.title || "AHP Survey";
  document.getElementById("survey_instructions").textContent = cfg.instructions || "";

  const C = cfg.criteria;
  const n = C.length;
  const block = document.getElementById("pairwise_block");
  block.innerHTML = "";

  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  trh.innerHTML = `<th>Row \\ Col</th>` + C.map(c => `<th>${escapeHTML(c)}</th>`).join("");
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");

  const opts = [1/9,1/8,1/7,1/6,1/5,1/4,1/3,1/2,1,2,3,4,5,6,7,8,9];

  for (let i=0;i<n;i++) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>${escapeHTML(C[i])}</th>`;
    for (let j=0;j<n;j++) {
      const td = document.createElement("td");
      if (i===j) {
        td.textContent = "1";
        td.dataset.fixed = "1";
      } else if (i<j) {
        const sel = document.createElement("select");
        sel.dataset.i = i; sel.dataset.j = j;
        opts.forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v; opt.text = (v>=1)? `${v}` : `1/${Math.round(1/v)}`;
          if (v===1) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", mirror);
        td.appendChild(sel);
      } else {
        const span = document.createElement("span");
        span.id = `mirror_${i}_${j}`;
        span.textContent = "1";
        td.appendChild(span);
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  block.appendChild(tbl);
}

function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }

/* ====== MIRROR RECIPROCALS ====== */
function mirror(e){
  const i = +e.target.dataset.i, j = +e.target.dataset.j;
  const val = parseFloat(e.target.value);
  const m = (1/val).toFixed(5);
  const target = document.getElementById(`mirror_${j}_${i}`);
  if (target) target.textContent = m;
}

/* ====== BUILD MATRIX ====== */
function buildMatrix(){
  const C = AHP_CFG.criteria;
  const n = C.length;
  const A = Array.from({length:n},()=>Array(n).fill(1));
  const selects = document.querySelectorAll('select[data-i]');
  selects.forEach(sel=>{
    const i = +sel.dataset.i, j = +sel.dataset.j;
    const v = parseFloat(sel.value);
    A[i][j] = v; A[j][i] = 1/v;
  });
  return A;
}

/* ====== AHP CORE ====== */
function geometricMeanRow(row){
  // product^(1/n)
  let prod = 1, n = row.length;
  for (let k=0;k<n;k++) prod *= row[k];
  return Math.pow(prod, 1/n);
}

function normalize(vec){
  const s = vec.reduce((a,b)=>a+b,0);
  return vec.map(v=>v/s);
}

function eigenApprox(A){ // row geometric mean approximation
  const n = A.length;
  const w = new Array(n);
  for (let i=0;i<n;i++) w[i] = geometricMeanRow(A[i]);
  return normalize(w);
}

function lambdaMax(A, w){
  const n = A.length;
  const Aw = Array(n).fill(0);
  for (let i=0;i<n;i++){
    for (let j=0;j<n;j++) Aw[i] += A[i][j]*w[j];
  }
  let sum = 0;
  for (let i=0;i<n;i++) sum += (Aw[i]/w[i]);
  return sum/n;
}

/* ====== VALIDATION ====== */
function requireFieldsOrAlert() {
  const name = document.getElementById('resp_name').value.trim();
  const email = document.getElementById('resp_email').value.trim();
  const consent = document.getElementById('resp_consent').checked;

  if (!name) { alert("Please enter your name."); return false; }
  if (!email || !/^\S+@\S+\.\S+$/.test(email)) { alert("Please enter a valid email address."); return false; }
  if (!consent) { alert("Please tick the consent checkbox to proceed."); return false; }
  return true;
}

/* ====== COMPUTE + RENDER ====== */
function computeAHP(){
  if (!requireFieldsOrAlert()) return;

  const A = buildMatrix();
  const C = AHP_CFG.criteria;
  const n = C.length;

  const w = eigenApprox(A);
  const lam = lambdaMax(A, w);
  const CI = (n>1) ? (lam - n) / (n - 1) : 0;
  const ri = RI[n] ?? 1.49;
  const CR = (ri===0)? 0 : (CI/ri);

  // table
  const tbl = document.getElementById("weights_tbl");
  tbl.innerHTML = `<tr><th>Criterion</th><th>Weight</th></tr>` +
    C.map((c,idx)=>`<tr><td>${escapeHTML(c)}</td><td>${w[idx].toFixed(4)}</td></tr>`).join("") +
    `<tr><th>Total</th><th>${w.reduce((a,b)=>a+b,0).toFixed(4)}</th></tr>`;

  // msg
  const msg = document.getElementById("consistency_msg");
  const ok = CR <= 0.10;
  msg.innerHTML = `n=${n}, &lambda;<sub>max</sub>=${lam.toFixed(4)}, CI=${CI.toFixed(4)}, RI=${ri.toFixed(2)}, ` +
    `CR=${CR.toFixed(3)} · ` +
    (ok ? `<span class="ok">Consistent (≤ 0.10)</span>` :
                `<span class="warn">Inconsistent (&gt; 0.10) — please revise judgements.</span>`);

  // chart
  const ctx = document.getElementById('chart');
  if (window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: C, datasets: [{ label: 'Weights', data: w }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero:true, max:1 } } }
  });

  document.getElementById("results").style.display = "block";
  window._AHP_RESULT = {
    model_id: AHP_CFG.model_id || null,
    criteria: C,
    weights: w,
    lambda_max: lam,
    CI, CR, n,
    matrix: A,
    respondent: meta(),
    ts: new Date().toISOString()
  };
}

function meta(){
  return {
    name: document.getElementById('resp_name').value.trim(),
    affiliation: document.getElementById('resp_affil').value.trim() || null,
    email: document.getElementById('resp_email').value.trim(),
    consent: document.getElementById('resp_consent').checked,
    ua: navigator.userAgent
  }
}

/* ====== EXPORTS ====== */
function exportCSV(){
  if (!window._AHP_RESULT){ alert("Compute first."); return; }
  const r = window._AHP_RESULT;
  let csv = "criterion,weight\n";
  r.criteria.forEach((c,i)=>csv += `${c},${r.weights[i]}\n`);
  csv += `total,${r.weights.reduce((a,b)=>a+b,0)}\n`;
  csv += `lambda_max,${r.lambda_max}\nCI,${r.CI}\nCR,${r.CR}\n`;
  download(csv, `ahp_${r.model_id || 'results'}.csv`, "text/csv");
}

function exportJSON(){
  if (!window._AHP_RESULT){ alert("Compute first."); return; }
  download(JSON.stringify(window._AHP_RESULT,null,2),
           `ahp_${window._AHP_RESULT.model_id || 'results'}.json`, "application/json");
}

function download(content, filename, mime){
  const a = document.createElement('a');
  a.href = URL.createObjectURL( new Blob([content], {type:mime}) );
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== SUBMIT TO GOOGLE SHEETS ====== */
async function submitToSheets(){
  if (!APPS_SCRIPT_ENDPOINT){ alert("No endpoint configured yet."); return; }
  if (!window._AHP_RESULT){ alert("Compute first."); return; }

  // enforce required fields again
  if (!requireFieldsOrAlert()) return;

  try{
    const res = await fetch(APPS_SCRIPT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(window._AHP_RESULT)
    });
    if (!res.ok) throw new Error("HTTP "+res.status);
    alert("Submitted. Thank you!");
  } catch(e){
    alert("Submit failed: " + e.message);
  }
}

/* ====== UTIL ====== */
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
